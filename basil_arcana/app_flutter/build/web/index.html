<!DOCTYPE html>
<html>
<head>
  <base href="/">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Basil's Arcana">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  >

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <!-- build: 2026-02-08-rollback -->

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Basil's Arcana">

  <title>Basil's Arcana</title>
  <script>
    window.__bootError = null;
    window.addEventListener('error', function (event) {
      window.__bootError = {
        message: event.message || 'Unknown error',
        source: event.filename || '',
        line: event.lineno || 0,
        column: event.colno || 0,
      };
      console.error('[boot] error', window.__bootError);
    });
    window.addEventListener('unhandledrejection', function (event) {
      window.__bootError = {
        message: event.reason ? String(event.reason) : 'Unhandled rejection',
      };
      console.error('[boot] unhandledrejection', window.__bootError);
    });
  </script>
  <script>
    function resolveBuildId() {
      var buildId = '__BUILD_ID__';
      if (!buildId || buildId === '__BUILD_ID__' || buildId === 'null') {
        buildId = String(Date.now());
      }
      return String(buildId).trim() || 'dev';
    }

    var v = resolveBuildId();
    window.__buildVersion = v;
    window.__flutterBootstrapUrl = 'flutter_bootstrap.js?v=' + v;
    window.__configUrl = 'config.json?v=' + v;

    (function appendVersionedBootstrapHints() {
      var bootstrapPreload = document.createElement('link');
      bootstrapPreload.rel = 'preload';
      bootstrapPreload.as = 'script';
      bootstrapPreload.href = window.__flutterBootstrapUrl;
      document.head.appendChild(bootstrapPreload);
    })();
  </script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    function loadScript(src, attrs) {
      return new Promise(function (resolve, reject) {
        var script = document.createElement('script');
        script.src = src;
        if (attrs) {
          Object.keys(attrs).forEach(function (key) {
            script.setAttribute(key, attrs[key]);
          });
        }
        script.onload = function () { resolve(); };
        script.onerror = function () {
          reject(new Error('Failed to load ' + src));
        };
        document.head.appendChild(script);
      });
    }


  </script>
  <link rel="manifest" href="manifest.json">
  <style>
    :root {
      --tg-vh: 1vh;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #0f0f12;
      overflow: hidden;
      overscroll-behavior: none;
    }

    html.tg-webview body {
      overflow: hidden;
    }

    #tg-scroll-root {
      height: calc(var(--tg-vh) * 100);
      width: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: none;
      box-sizing: border-box;
      padding-top: env(safe-area-inset-top);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
    }

    #flutter_mount {
      min-height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <script>
    function isTelegramWebView() {
      if (window.Telegram && window.Telegram.WebApp) {
        return true;
      }
      var userAgent = navigator.userAgent || '';
      return userAgent.toLowerCase().indexOf('telegram') !== -1;
    }

    function isTelegramIOS() {
      if (!isTelegramWebView()) {
        return false;
      }
      if (window.Telegram && window.Telegram.WebApp) {
        return window.Telegram.WebApp.platform === 'ios';
      }
      var userAgent = navigator.userAgent || '';
      return /iphone|ipad|ipod/i.test(userAgent);
    }

    (function purgeWebCachesAndStorage() {
      var cacheKeyFragments = [
        'cards_',
        'cardsCache',
        'cards-cache',
        'deckCards',
        'cardsRu',
        'cardsKz',
        'cardsEn',
        'cdn_cards_',
        'flutter.cdn_cards_',
        'basil_cards',
        'spreads_',
        'spreadsCache',
        'spreads-cache',
        'deckSpreads',
        'spreadsRu',
        'spreadsKz',
        'spreadsEn',
        'cdn_spreads_',
        'flutter.cdn_spreads_',
        'basil_spreads'
      ];

      function shouldRemoveKey(key) {
        return cacheKeyFragments.some(function (fragment) {
          return key.indexOf(fragment) !== -1;
        });
      }

      function purgeStorage(storage, label) {
        if (!storage || typeof storage.length !== 'number') {
          return [];
        }
        var removedKeys = [];
        for (var i = storage.length - 1; i >= 0; i--) {
          var key = storage.key(i);
          if (!key) {
            continue;
          }
          if (shouldRemoveKey(key)) {
            removedKeys.push(key);
            storage.removeItem(key);
          }
        }
        console.info('[cache-cleanup]', label, 'removed keys:', removedKeys);
        return removedKeys;
      }

      if ('serviceWorker' in navigator && navigator.serviceWorker) {
        navigator.serviceWorker.getRegistrations().then(function (registrations) {
          registrations.forEach(function (registration) {
            registration.unregister();
          });
        }).catch(function (error) {
          console.warn('Service worker cleanup failed', error);
        });
      }

      if (window.caches && caches.keys) {
        caches.keys().then(function (keys) {
          return Promise.all(keys.map(function (key) {
            return caches.delete(key);
          }));
        }).catch(function (error) {
          console.warn('CacheStorage cleanup failed', error);
        });
      }

      try {
        purgeStorage(window.localStorage, 'localStorage');
      } catch (error) {
        console.warn('localStorage cleanup failed', error);
      }

      try {
        purgeStorage(window.sessionStorage, 'sessionStorage');
      } catch (error) {
        console.warn('sessionStorage cleanup failed', error);
      }
    })();

    (function setupTelegramWebApp() {
      if (!window.Telegram || !window.Telegram.WebApp) {
        return;
      }

      var tg = window.Telegram.WebApp;
      document.documentElement.classList.add('tg-webview');

      function updateTelegramViewportHeight() {
        var height = tg.viewportHeight || window.innerHeight || 0;
        var heightPx = height + 'px';
        document.documentElement.style.setProperty('--tg-vh', (height * 0.01) + 'px');
        document.documentElement.style.height = heightPx;
        document.body.style.height = heightPx;
      }

      try {
        tg.ready();
        if (typeof tg.setBackgroundColor === 'function') {
          tg.setBackgroundColor('#0f0f12');
        }
        if (typeof tg.setHeaderColor === 'function') {
          tg.setHeaderColor('#0f0f12');
        }
        var platform = tg.platform;
        var isMobilePlatform = platform === 'ios' || platform === 'android';
        if (isMobilePlatform && typeof tg.expand === 'function') {
          tg.expand();
        }
      } catch (error) {
        console.warn('Telegram WebApp init failed', error);
      }

      updateTelegramViewportHeight();
      if (typeof tg.onEvent === 'function') {
        tg.onEvent('viewportChanged', updateTelegramViewportHeight);
      }

      if (typeof tg.disableVerticalSwipes === 'function') {
        try {
          tg.disableVerticalSwipes();
        } catch (error) {
          console.warn('Telegram disableVerticalSwipes failed', error);
        }
      }

      window.addEventListener('DOMContentLoaded', function () {
        var scrollRoot = document.getElementById('tg-scroll-root');
        if (!scrollRoot) {
          return;
        }

        var startY = 0;
        scrollRoot.addEventListener('touchstart', function (event) {
          if (event.touches && event.touches.length) {
            startY = event.touches[0].clientY;
          }
        }, { passive: true });

        scrollRoot.addEventListener('touchmove', function (event) {
          if (!event.touches || event.touches.length !== 1) {
            return;
          }
          var currentY = event.touches[0].clientY;
          var deltaY = currentY - startY;
          var scrollTop = scrollRoot.scrollTop;
          var maxScroll = scrollRoot.scrollHeight - scrollRoot.clientHeight;
          if ((scrollTop <= 0 && deltaY > 0) || (scrollTop >= maxScroll && deltaY < 0)) {
            event.preventDefault();
          }
        }, { passive: false });

        document.body.addEventListener('touchmove', function (event) {
          if (!scrollRoot.contains(event.target)) {
            event.preventDefault();
          }
        }, { passive: false });
      });
    })();

    (function setupDebugOverlay() {
      var params = new URLSearchParams(window.location.search || '');
      if (params.get('debug') !== '1') {
        return;
      }
      var overlay = document.createElement('div');
      overlay.id = 'web-debug-overlay';
      overlay.style.position = 'fixed';
      overlay.style.zIndex = '9999';
      overlay.style.left = '12px';
      overlay.style.right = '12px';
      overlay.style.bottom = '12px';
      overlay.style.maxHeight = '40vh';
      overlay.style.overflow = 'auto';
      overlay.style.background = 'rgba(20, 16, 24, 0.92)';
      overlay.style.border = '1px solid rgba(255, 255, 255, 0.2)';
      overlay.style.borderRadius = '10px';
      overlay.style.padding = '10px';
      overlay.style.fontFamily = 'system-ui, sans-serif';
      overlay.style.fontSize = '12px';
      overlay.style.color = '#fff';

      var title = document.createElement('div');
      title.textContent = 'Debug errors';
      title.style.fontWeight = '600';
      title.style.marginBottom = '6px';
      overlay.appendChild(title);

      var list = document.createElement('div');
      overlay.appendChild(list);

      function appendMessage(message) {
        var item = document.createElement('div');
        item.textContent = message;
        item.style.marginTop = '6px';
        item.style.whiteSpace = 'pre-wrap';
        list.appendChild(item);
      }

      window.addEventListener('error', function (event) {
        appendMessage(event.message || 'Unknown error');
      });
      window.addEventListener('unhandledrejection', function (event) {
        appendMessage(event.reason ? String(event.reason) : 'Unhandled rejection');
      });

      document.body.appendChild(overlay);
    })();
  </script>
  <div id="tg-scroll-root">
    <div id="flutter_mount"></div>
  </div>
  <script>
    window.addEventListener('load', function (ev) {
      var v = window.__buildVersion || 'dev';
      window.__flutterBootstrapUrl = 'flutter_bootstrap.js?v=' + v;
      loadScript('telegram_bridge.js?v=' + v).then(function () {
        return loadScript('flutter.js?v=' + v, { defer: '' });
      }).then(function () {
        _flutter.loader.loadEntrypoint({
          entrypointUrl: 'main.dart.js?v=' + v,
          serviceWorker: null,
          onEntrypointLoaded: function (engineInitializer) {
            engineInitializer.initializeEngine({
              hostElement: document.getElementById('flutter_mount')
            }).then(function (appRunner) {
              appRunner.runApp();
            });
          }
        });
      }).catch(function (error) {
        window.__bootError = {
          message: error ? String(error) : 'Unknown bootstrap error'
        };
        console.error('[boot] load error', error);
      });
    });
  </script>
</body>
</html>
