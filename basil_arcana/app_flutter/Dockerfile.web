FROM ghcr.io/cirruslabs/flutter:stable AS build

WORKDIR /app

COPY pubspec.yaml pubspec.lock ./
RUN flutter pub get

COPY . .

ARG API_BASE_URL
ENV API_BASE_URL=${API_BASE_URL}

RUN flutter gen-l10n
RUN flutter build web --release --dart-define=API_BASE_URL=${API_BASE_URL}

FROM python:3.12-slim AS runtime

WORKDIR /app

RUN useradd --create-home appuser
USER appuser

COPY --from=build /app/build/web ./

EXPOSE 8080

CMD ["python", "-m", "http.server", "8080", "--directory", "/app"]
