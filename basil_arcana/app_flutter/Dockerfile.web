FROM ghcr.io/cirruslabs/flutter:stable AS build

WORKDIR /app

COPY pubspec.yaml ./
# pubspec.lock is not committed for Flutter apps; avoid failing builds when it's absent.
RUN flutter pub get

COPY . .

ARG API_BASE_URL
ARG ASSETS_BASE_URL
ARG APP_VERSION
ENV API_BASE_URL=${API_BASE_URL}
ENV ASSETS_BASE_URL=${ASSETS_BASE_URL}
ENV APP_VERSION=${APP_VERSION}

# Build args for Railway: API_BASE_URL (example: docker build --build-arg API_BASE_URL=https://api.example.com -f app_flutter/Dockerfile.web .)
RUN if [ ! -d "web" ]; then \
      flutter config --enable-web && \
      flutter create . --platforms web; \
    fi

RUN flutter gen-l10n && flutter build web --release --pwa-strategy=none \
    --dart-define=API_BASE_URL="${API_BASE_URL}" \
    --dart-define=ASSETS_BASE_URL="${ASSETS_BASE_URL}" \
    --dart-define=APP_VERSION="${APP_VERSION}"

FROM python:3.12-slim AS runtime

WORKDIR /app

RUN useradd --create-home --uid 10001 appuser && \
    mkdir -p /app/static && \
    chown -R appuser:appuser /app /app/static
USER appuser

ENV WEB_ROOT=/app/static
ENV CONFIG_DIR=/app/static

# Web build output is served from /app/static.
COPY --from=build --chown=appuser:appuser /app/build/web /app/static
COPY --from=build --chown=appuser:appuser /app/web_server.py /app/web_server.py

EXPOSE 8080

CMD ["python", "/app/web_server.py"]
