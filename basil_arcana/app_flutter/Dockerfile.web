FROM ghcr.io/cirruslabs/flutter:stable AS build

WORKDIR /app

COPY pubspec.yaml ./
# pubspec.lock is not committed for Flutter apps; avoid failing builds when it's absent.
RUN flutter pub get

COPY . .

ARG API_BASE_URL
ARG API_KEY
ENV API_BASE_URL=${API_BASE_URL}
ENV API_KEY=${API_KEY}

# Build args for Railway: API_BASE_URL, API_KEY (example: docker build --build-arg API_BASE_URL=https://api.example.com --build-arg API_KEY=secret -f app_flutter/Dockerfile.web .)
RUN if [ ! -d "web" ]; then \
      flutter config --enable-web && \
      flutter create . --platforms web; \
    fi

RUN flutter gen-l10n && \
    flutter build web --release --pwa-strategy=none \
      --dart-define=API_BASE_URL="${API_BASE_URL}" \
      --dart-define=API_KEY="${API_KEY}"

FROM python:3.12-slim AS runtime

WORKDIR /app

RUN useradd --create-home appuser
USER appuser

COPY --from=build /app/build/web ./
COPY --from=build /app/web_server.py ./web_server.py

EXPOSE 8080

CMD ["python", "/app/web_server.py"]
