<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Basil's Arcana">

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Basil's Arcana">

  <title>Basil's Arcana</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="manifest" href="manifest.json">
  <style>
    :root {
      --tg-vh: 1vh;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #0f0f12;
      overflow: hidden;
      overscroll-behavior: none;
    }

    html.tg-webview body {
      overflow: hidden;
      box-sizing: border-box;
      padding-top: max(
        env(safe-area-inset-top),
        var(--tg-safe-area-inset-top, 0px),
        var(--tg-content-safe-area-inset-top, 0px)
      );
    }

    #tg-scroll-root {
      height: calc(var(--tg-vh) * 100);
      width: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: none;
    }

    #flutter_mount {
      min-height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <script>
    // This is used by Flutter build to replace with a concrete version.
    var serviceWorkerVersion = null;

    function isTelegramWebView() {
      if (window.Telegram && window.Telegram.WebApp) {
        return true;
      }
      var userAgent = navigator.userAgent || '';
      return userAgent.toLowerCase().indexOf('telegram') !== -1;
    }

    (function setupTelegramWebApp() {
      var tg = window.Telegram ? window.Telegram.WebApp : null;
      if (!tg) {
        return;
      }
      document.documentElement.classList.add('tg-webview');

      function updateTelegramViewportHeight() {
        var height = tg.viewportHeight || window.innerHeight || 0;
        var heightPx = height + 'px';
        document.documentElement.style.setProperty('--tg-vh', (height * 0.01) + 'px');
        document.documentElement.style.height = heightPx;
        document.body.style.height = heightPx;
      }

      var flutterBuildMode = '{{flutter_build_mode}}';
      var isDebugBuild = Boolean(flutterBuildMode) &&
        !flutterBuildMode.includes('{{') &&
        flutterBuildMode !== 'release' &&
        flutterBuildMode !== 'profile';
      var didExpand = false;
      var didRequestFullscreen = false;

      try {
        tg.ready();
        var platform = tg.platform;
        var isMobilePlatform = platform === 'ios' || platform === 'android';
        if (isMobilePlatform && typeof tg.expand === 'function') {
          tg.expand();
          didExpand = true;
        }
        if (isMobilePlatform && typeof tg.requestFullscreen === 'function') {
          tg.requestFullscreen();
          didRequestFullscreen = true;
        }
        if (isDebugBuild) {
          console.log('[Telegram WebApp] platform:', platform);
          console.log('[Telegram WebApp] expand:', didExpand, 'fullscreen:', didRequestFullscreen);
        }
      } catch (error) {
        console.warn('Telegram WebApp init failed', error);
      }

      updateTelegramViewportHeight();
      if (typeof tg.onEvent === 'function') {
        tg.onEvent('viewportChanged', updateTelegramViewportHeight);
      }

      if (typeof tg.disableVerticalSwipes === 'function') {
        try {
          tg.disableVerticalSwipes();
        } catch (error) {
          console.warn('Telegram disableVerticalSwipes failed', error);
        }
      }

      if (typeof tg.enableClosingConfirmation === 'function') {
        try {
          tg.enableClosingConfirmation();
        } catch (error) {
          console.warn('Telegram enableClosingConfirmation failed', error);
        }
      }

      window.addEventListener('DOMContentLoaded', function () {
        var scrollRoot = document.getElementById('tg-scroll-root');
        if (!scrollRoot) {
          return;
        }

        var startY = 0;
        scrollRoot.addEventListener('touchstart', function (event) {
          if (event.touches && event.touches.length) {
            startY = event.touches[0].clientY;
          }
        }, { passive: true });

        scrollRoot.addEventListener('touchmove', function (event) {
          if (!event.touches || event.touches.length !== 1) {
            return;
          }
          var currentY = event.touches[0].clientY;
          var deltaY = currentY - startY;
          var scrollTop = scrollRoot.scrollTop;
          var maxScroll = scrollRoot.scrollHeight - scrollRoot.clientHeight;
          if ((scrollTop <= 0 && deltaY > 0) || (scrollTop >= maxScroll && deltaY < 0)) {
            event.preventDefault();
          }
        }, { passive: false });

        document.body.addEventListener('touchmove', function (event) {
          if (!scrollRoot.contains(event.target)) {
            event.preventDefault();
          }
        }, { passive: false });
      });
    })();
  </script>
  <div id="tg-scroll-root">
    <div id="flutter_mount"></div>
  </div>
  <script>
    var flutterBuildMode = '{{flutter_build_mode}}';
    var isDebugBuild = Boolean(flutterBuildMode) &&
      !flutterBuildMode.includes('{{') &&
      flutterBuildMode !== 'release' &&
      flutterBuildMode !== 'profile';

    function showFlutterLoadError(message) {
      if (!isDebugBuild) {
        return;
      }
      var overlay = document.getElementById('flutter-error-overlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'flutter-error-overlay';
        overlay.style.position = 'fixed';
        overlay.style.top = '16px';
        overlay.style.left = '16px';
        overlay.style.right = '16px';
        overlay.style.padding = '12px';
        overlay.style.background = 'rgba(98, 0, 0, 0.92)';
        overlay.style.color = '#fff';
        overlay.style.fontFamily = 'sans-serif';
        overlay.style.fontSize = '14px';
        overlay.style.borderRadius = '10px';
        overlay.style.zIndex = '9999';
        document.body.appendChild(overlay);
      }
      overlay.textContent = message;
    }

    window.addEventListener('error', function (event) {
      if (event && event.message) {
        showFlutterLoadError('Flutter error: ' + event.message);
      }
    });
    window.addEventListener('unhandledrejection', function (event) {
      if (event && event.reason) {
        showFlutterLoadError('Flutter error: ' + event.reason);
      }
    });

    window.flutterConfiguration = {
      hostElement: document.getElementById('flutter_mount'),
      serviceWorker: null
    };
  </script>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
