<!DOCTYPE html>
<html>
<head>
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Basil's Arcana">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  >

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Basil's Arcana">

  <title>Basil's Arcana</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="manifest" href="manifest.json">
  <style>
    :root {
      --tg-vh: 1vh;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #0f0f12;
      overflow: hidden;
      overscroll-behavior: none;
    }

    html.tg-webview body {
      overflow: hidden;
    }

    #tg-scroll-root {
      height: calc(var(--tg-vh) * 100);
      width: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: none;
      box-sizing: border-box;
      padding-top: env(safe-area-inset-top);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
    }

    #flutter_mount {
      min-height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <script>
    // This is used by Flutter build to replace with a concrete version.
    var serviceWorkerVersion = null;
    var buildVersion = '{{flutter_service_worker_version}}';
    if (!buildVersion ||
        buildVersion === 'null' ||
        buildVersion === '{{flutter_service_worker_version}}') {
      buildVersion = 'dev';
    }
    window.__buildVersion = buildVersion;

    function isTelegramWebView() {
      if (window.Telegram && window.Telegram.WebApp) {
        return true;
      }
      var userAgent = navigator.userAgent || '';
      return userAgent.toLowerCase().indexOf('telegram') !== -1;
    }

    function isTelegramIOS() {
      if (!isTelegramWebView()) {
        return false;
      }
      if (window.Telegram && window.Telegram.WebApp) {
        return window.Telegram.WebApp.platform === 'ios';
      }
      var userAgent = navigator.userAgent || '';
      return /iphone|ipad|ipod/i.test(userAgent);
    }

    (function clearTelegramIOSCache() {
      if (!isTelegramIOS()) {
        return;
      }
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function (registrations) {
          registrations.forEach(function (registration) {
            registration.unregister();
          });
        }).catch(function (error) {
          console.warn('Telegram iOS service worker cleanup failed', error);
        });
      }
      if (window.caches && caches.keys) {
        caches.keys().then(function (keys) {
          return Promise.all(keys.map(function (key) {
            return caches.delete(key);
          }));
        }).catch(function (error) {
          console.warn('Telegram iOS cache cleanup failed', error);
        });
      }
    })();

    (function setupTelegramWebApp() {
      if (!window.Telegram || !window.Telegram.WebApp) {
        return;
      }

      var tg = window.Telegram.WebApp;
      document.documentElement.classList.add('tg-webview');

      function updateTelegramViewportHeight() {
        var height = tg.viewportHeight || window.innerHeight || 0;
        var heightPx = height + 'px';
        document.documentElement.style.setProperty('--tg-vh', (height * 0.01) + 'px');
        document.documentElement.style.height = heightPx;
        document.body.style.height = heightPx;
      }

      try {
        tg.ready();
        if (typeof tg.setBackgroundColor === 'function') {
          tg.setBackgroundColor('#0f0f12');
        }
        if (typeof tg.setHeaderColor === 'function') {
          tg.setHeaderColor('#0f0f12');
        }
        var platform = tg.platform;
        var isMobilePlatform = platform === 'ios' || platform === 'android';
        if (isMobilePlatform && typeof tg.expand === 'function') {
          tg.expand();
        }
      } catch (error) {
        console.warn('Telegram WebApp init failed', error);
      }

      updateTelegramViewportHeight();
      if (typeof tg.onEvent === 'function') {
        tg.onEvent('viewportChanged', updateTelegramViewportHeight);
      }

      if (typeof tg.disableVerticalSwipes === 'function') {
        try {
          tg.disableVerticalSwipes();
        } catch (error) {
          console.warn('Telegram disableVerticalSwipes failed', error);
        }
      }

      window.addEventListener('DOMContentLoaded', function () {
        var scrollRoot = document.getElementById('tg-scroll-root');
        if (!scrollRoot) {
          return;
        }

        var startY = 0;
        scrollRoot.addEventListener('touchstart', function (event) {
          if (event.touches && event.touches.length) {
            startY = event.touches[0].clientY;
          }
        }, { passive: true });

        scrollRoot.addEventListener('touchmove', function (event) {
          if (!event.touches || event.touches.length !== 1) {
            return;
          }
          var currentY = event.touches[0].clientY;
          var deltaY = currentY - startY;
          var scrollTop = scrollRoot.scrollTop;
          var maxScroll = scrollRoot.scrollHeight - scrollRoot.clientHeight;
          if ((scrollTop <= 0 && deltaY > 0) || (scrollTop >= maxScroll && deltaY < 0)) {
            event.preventDefault();
          }
        }, { passive: false });

        document.body.addEventListener('touchmove', function (event) {
          if (!scrollRoot.contains(event.target)) {
            event.preventDefault();
          }
        }, { passive: false });
      });
    })();

    (function setupDebugOverlay() {
      var params = new URLSearchParams(window.location.search || '');
      if (params.get('debug') !== '1') {
        return;
      }
      var overlay = document.createElement('div');
      overlay.id = 'web-debug-overlay';
      overlay.style.position = 'fixed';
      overlay.style.zIndex = '9999';
      overlay.style.left = '12px';
      overlay.style.right = '12px';
      overlay.style.bottom = '12px';
      overlay.style.maxHeight = '40vh';
      overlay.style.overflow = 'auto';
      overlay.style.background = 'rgba(20, 16, 24, 0.92)';
      overlay.style.border = '1px solid rgba(255, 255, 255, 0.2)';
      overlay.style.borderRadius = '10px';
      overlay.style.padding = '10px';
      overlay.style.fontFamily = 'system-ui, sans-serif';
      overlay.style.fontSize = '12px';
      overlay.style.color = '#fff';

      var title = document.createElement('div');
      title.textContent = 'Debug errors';
      title.style.fontWeight = '600';
      title.style.marginBottom = '6px';
      overlay.appendChild(title);

      var list = document.createElement('div');
      overlay.appendChild(list);

      function appendMessage(message) {
        var item = document.createElement('div');
        item.textContent = message;
        item.style.marginTop = '6px';
        item.style.whiteSpace = 'pre-wrap';
        list.appendChild(item);
      }

      window.addEventListener('error', function (event) {
        appendMessage(event.message || 'Unknown error');
      });
      window.addEventListener('unhandledrejection', function (event) {
        appendMessage(event.reason ? String(event.reason) : 'Unhandled rejection');
      });

      document.body.appendChild(overlay);
    })();
  </script>
  <div id="tg-scroll-root">
    <div id="flutter_mount"></div>
  </div>
  <script src="flutter.js?v={{flutter_service_worker_version}}" defer></script>
  <script>
    window.addEventListener('load', function (ev) {
      var disableServiceWorker = true || isTelegramWebView();
      _flutter.loader.loadEntrypoint({
        entrypointUrl: 'main.dart.js?v=' + window.__buildVersion,
        serviceWorker: disableServiceWorker
          ? null
          : { serviceWorkerVersion: serviceWorkerVersion },
        onEntrypointLoaded: function (engineInitializer) {
          engineInitializer.initializeEngine({
            hostElement: document.getElementById('flutter_mount')
          }).then(function (appRunner) {
            appRunner.runApp();
          });
        }
      });
    });
  </script>
</body>
</html>
