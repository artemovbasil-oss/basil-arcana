# Basil’s Arcana

Basil’s Arcana is a calm, reflective tarot MVP designed to help you explore questions for clarity, not certainty. The Flutter app draws from the Major Arcana and pairs the cards with a grounded interpretation generated by the API (with an offline fallback when AI is unavailable).

**Tagline:** “Reflective tarot readings for clarity, not certainty.”

## Server: Run locally

```bash
cd server
npm install
export OPENAI_API_KEY=your_key_here
# Required for authenticated API calls:
export ARCANA_API_KEY=your_arcana_key_here
# Optional: export OPENAI_MODEL=gpt-4o-mini
# Optional rate limit overrides:
# export RATE_LIMIT_WINDOW_MS=60000
# export RATE_LIMIT_MAX=60
npm start
```

Health check:

```bash
curl http://localhost:3000/health
```

Root route:

```bash
curl http://localhost:3000/
```

Generate a reading (missing/invalid API key should return 401):

```bash
curl -X POST http://localhost:3000/api/reading/generate \
  -H "Content-Type: application/json" \
  -H "x-api-key: your_arcana_key_here" \
  -d '{
    "question":"What should I focus on right now?",
    "spread":{
      "id":"spread_1_focus",
      "name":"Focus / Advice",
      "positions":[{"id":"p1","title":"Focus / Advice"}]
    },
    "cards":[{
      "positionId":"p1",
      "positionTitle":"Focus / Advice",
      "cardId":"major_08_strength",
      "cardName":"Strength",
      "keywords":["resilience","gentle power"],
      "meaning":{
        "general":"Inner steadiness is more powerful than force.",
        "light":"Patience and empathy help you hold the moment.",
        "shadow":"Self-doubt could soften your resolve.",
        "advice":"Lead with kindness, and trust your endurance."
      }
    }],
    "tone":"neutral"
  }'
```

## Deploy to Railway

1. Create a Railway project from this GitHub repo.
2. For the Flutter web service, point Railway to `basil_arcana/app_flutter/Dockerfile.web` and set `API_BASE_URL`.
3. In Railway Variables, set:
   - `OPENAI_API_KEY`
   - `ARCANA_API_KEY`
   - `OPENAI_MODEL` (optional)
   - `RATE_LIMIT_WINDOW_MS` (optional, default 60000)
   - `RATE_LIMIT_MAX` (optional, default 60)
4. Ensure the `start` script runs (`npm start`). Railway uses `process.env.PORT`.
5. Use the Railway public URL to test `/health`.

## Telegram bot (Railway)

1. Set bot variables in Railway:
   - `TELEGRAM_BOT_TOKEN`
   - `ARCANA_API_KEY`
   - `API_BASE_URL` (optional, defaults to `https://api.basilarcana.com`)
   - `DEFAULT_LOCALE` (`en`, `ru`, or `kk`)
   - `FLUTTER_ASSETS_ROOT=/app/basil_arcana/app_flutter/assets`
2. Build command: `cd bot && npm ci && npm run build`
3. Start command: `cd bot && npm run start`

## Attach custom domain: api.basilarcana.com

1. In Railway → Settings → Domains, add `api.basilarcana.com`.
2. In DNS, create a CNAME record:
   - Name: `api`
   - Target: the Railway-provided hostname
3. If using Cloudflare, set the proxy to **OFF** (DNS only).

## Flutter app: Run locally

```bash
cd app_flutter
flutter pub get
flutter run
```

### Set API base URL (dev override)

```bash
flutter run --dart-define=API_BASE_URL=http://10.0.2.2:3000
```

Production default: `https://api.basilarcana.com`.

## Notes
- Secrets are never committed to the repo. Use Railway Variables or local environment variables.
- No binary assets are included; all card faces are rendered with Flutter UI components.
