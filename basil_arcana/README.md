# Basil’s Arcana

Basil’s Arcana is a calm, reflective tarot MVP designed to help you explore questions for clarity, not certainty. The Flutter app draws from the Major Arcana and pairs the cards with a grounded interpretation generated by the API (with an offline fallback when AI is unavailable).

**Tagline:** “Reflective tarot readings for clarity, not certainty.”

## Server: Run locally

```bash
cd server
npm install
export OPENAI_API_KEY=your_key_here
# Required for authenticated API calls:
export ARCANA_API_KEY=your_arcana_key_here
# Optional: export OPENAI_MODEL=gpt-4o-mini
# Optional rate limit overrides:
# export RATE_LIMIT_WINDOW_MS=60000
# export RATE_LIMIT_MAX=60
npm start
```

Health check:

```bash
curl http://localhost:3000/health
```

Root route:

```bash
curl http://localhost:3000/
```

Generate a reading (missing/invalid API key should return 401):

```bash
curl -X POST http://localhost:3000/api/reading/generate \
  -H "Content-Type: application/json" \
  -H "x-api-key: your_arcana_key_here" \
  -d '{
    "question":"What should I focus on right now?",
    "spread":{
      "id":"spread_1_focus",
      "name":"Focus / Advice",
      "positions":[{"id":"p1","title":"Focus / Advice"}]
    },
    "cards":[{
      "positionId":"p1",
      "positionTitle":"Focus / Advice",
      "cardId":"major_08_strength",
      "cardName":"Strength",
      "keywords":["resilience","gentle power"],
      "meaning":{
        "general":"Inner steadiness is more powerful than force.",
        "light":"Patience and empathy help you hold the moment.",
        "shadow":"Self-doubt could soften your resolve.",
        "advice":"Lead with kindness, and trust your endurance."
      }
    }],
    "tone":"neutral"
  }'
```

## Deploy to Railway

1. Create a Railway project from this GitHub repo.
2. For the Flutter web service, point Railway to `basil_arcana/app_flutter/Dockerfile.web` and set `API_BASE_URL`.
3. In Railway Variables for the API service, set:
   - `OPENAI_API_KEY`
   - `ARCANA_API_KEY`
   - `TELEGRAM_BOT_TOKEN` (required for Telegram Stars invoices in mini app)
   - `OPENAI_MODEL` (optional)
   - `RATE_LIMIT_WINDOW_MS` (optional, default 60000)
   - `RATE_LIMIT_MAX` (optional, default 60)
   - `STARS_PACK_FULL_XTR` (optional, default `5`)
   - `STARS_PACK_WEEK_XTR` (optional, default `99`)
   - `STARS_PACK_MONTH_XTR` (optional, default `499`)
   - `STARS_PACK_YEAR_XTR` (optional, default `4999`)
4. Ensure the `start` script runs (`npm start`). Railway uses `process.env.PORT`.
5. Use the Railway public URL to test `/health`.

## Telegram bot (Railway)

1. Set bot variables in Railway:
   - `TELEGRAM_BOT_TOKEN`
   - `TELEGRAM_WEBAPP_URL` (optional, required only for the Launch app button)
2. WebApp must be opened via web_app button.
3. Build command: `cd bot && npm ci && npm run build`
4. Start command: `cd bot && npm run start`

## Attach custom domain: api.basilarcana.com

1. In Railway → Settings → Domains, add `api.basilarcana.com`.
2. In DNS, create a CNAME record:
   - Name: `api`
   - Target: the Railway-provided hostname
3. If using Cloudflare, set the proxy to **OFF** (DNS only).

## Flutter app: Run locally

```bash
cd app_flutter
flutter pub get
flutter run
```

### Set API base URL (dev override)

```bash
flutter run --dart-define=API_BASE_URL=http://10.0.2.2:3000
```

Production default: `https://api.basilarcana.com`.

## Notes
- Secrets are never committed to the repo. Use Railway Variables or local environment variables.
- The web client loads `/config.json` at runtime; set `API_BASE_URL` in the web service environment. No `API_KEY` is embedded in the web bundle.
- No binary assets are included; all card faces are rendered with Flutter UI components.

## Release checklist (web + bot + iOS Telegram)
- **Local web build**:
  - `cd app_flutter`
  - `flutter pub get`
  - `flutter gen-l10n`
  - `flutter build web --release --pwa-strategy=none --web-define=BUILD_ID=<build-id>`
  - `mkdir -p ../server/public`
  - `cp -R build/web/* ../server/public/`
- **Local bot build**:
  - `cd bot`
  - `npm ci`
  - `npm run build`
  - `npm run start`
- **Railway environment variables**:
  - Web service: `API_BASE_URL`
  - Web service (optional): `APP_VERSION` (default `2026-02-08-1`), `PUBLIC_ROOT` (default `server/public`)
  - API service: `OPENAI_API_KEY`, `ARCANA_API_KEY`, `TELEGRAM_BOT_TOKEN`, `DATABASE_URL` (+ optional `OPENAI_MODEL`, `SOFIA_NOTIFY_CHAT_ID`, rate limit vars, `STARS_PACK_FULL_XTR`, `STARS_PACK_WEEK_XTR`, `STARS_PACK_MONTH_XTR`, `STARS_PACK_YEAR_XTR`)
  - Bot service: `TELEGRAM_BOT_TOKEN`, `DATABASE_URL`, `TELEGRAM_WEBAPP_URL` (optional), `APP_VERSION` (optional), `SOFIA_CHAT_ID` (or `SOFIA_NOTIFY_CHAT_ID`)
- **iOS Telegram verification**:
  - Open the mini app via the bot button on iOS.
  - Confirm full-height layout (no black screen, no half-height), header not overlapping, and swipe-down doesn’t collapse the webview.
  - Open a card detail: video auto-plays once, then falls back to the static image; tapping the image replays the video once.
